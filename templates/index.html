<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gnome - Intruder Detector</title>
    <!-- Core theme CSS-->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <!-- Font Awesome icons -->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Logo Image -->
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}" type="image/png">
    <!-- Font style -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans|Poppins:400,700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
              <a class="navbar-brand" href="#">Gnome - Intruder Detector</a>
              <button
                  class="navbar-toggler"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#navbarNav"
                  aria-controls="navbarNav"
                  aria-expanded="false"
                  aria-label="Toggle navigation"
              >
                  <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="navbar-nav ms-auto"> <!-- 'ms-auto' pushes the items to the right -->
                      <li class="nav-item" >
                          <button class="btn btn-outline-light" style="margin-left: 10px; margin-top: 10px; margin-bottom: 10px; min-width: 100px;" data-bs-toggle="modal" data-bs-target="#signInModal">Sign In</button>
                      </li>
                      <li class="nav-item">
                          <button class="btn btn-outline-light" style="margin-left: 10px; margin-top: 10px; margin-bottom: 10px; min-width: 100px;" data-bs-toggle="modal" data-bs-target="#signUpModal">Sign Up</button>
                      </li>
                  </ul>
              </div>
          </div>
      </nav>
    </header>

    <!-- Sign Up Modal -->
    <div class="modal fade" id="signUpModal" tabindex="-1" aria-labelledby="signUpModalLabel" aria-hidden="true">
      <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
          <h5 class="modal-title" id="signUpModalLabel">Sign Up</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
          <!-- Alert placeholder -->
          <div id="modal-alert-placeholder-signUp"></div>

          <!-- Subscription Code, Password, and Telegram Chat ID -->
          <form id="signUpForm">
              <div class="mb-3">
              <label for="subscriptionCode-signUp" class="form-label">Channel Subscription Code</label>
              <input type="text" class="form-control" id="subscriptionCode-signUp" placeholder="eg. 000000" required>
              <small class="form-text text-muted">üìçNOTE: If you're new to our service or lost your subscription code, please contact our staff at Telegram <bold><a href="https://t.me/gnomeIntruderDetector">@gnomeIntruderDetector</bold></a>.</small>
              </div>
              <div class="mb-3">
              <label for="password-signUp" class="form-label">Password</label>
              <input type="password" class="form-control" id="password-signUp" placeholder="eg. 123456" required>
              <small class="form-text text-muted">Enter your password (or temporary password).</small>
              </div>
              <div class="mb-3">
              <label for="telegramChatID" class="form-label">Telegram Chat ID</label>
              <input type="text" class="form-control" id="telegramChatID" placeholder="eg. 1234567890" required>
              <small class="form-text text-muted">üìçNOTE: Visit BOT <bold><a href="https://t.me/raw_info_bot">@raw_info_bot</a></bold> and send any message to it to obtain your chat_id. It should be a 10-digit number. Visit our TELEGRAM BOT at <bold><a href="https://t.me/gnomeIntruderDetector">@intruderrDetector_bot</a></bold></small>
              </div>
              <div class="mb-3">
                <label for="phoneNum" class="form-label">Phone Number (Optional) </label>
                <input type="text" class="form-control" id="phoneNum" placeholder="eg. +60171234567">
                <small class="form-text text-muted">üìçEnter the phone number that you want to register. We will only send notification via SMS when the Telegram Bot is not reachable at your side. You can always update the phone number in your account.</small>
                </div>
              <button type="button" class="btn btn-dark" id="nextStepButton">Next</button>
          </form>
          </div>
      </div>
      </div>
    </div>


    <!-- Sign In Modal -->
    <div class="modal fade" id="signInModal" tabindex="-1" aria-labelledby="signInModalLabel" aria-hidden="true">
      <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
          <h5 class="modal-title" id="signInModalLabel">Sign In</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
          <!-- Alert placeholder -->
          <div id="modal-alert-placeholder-signIn"></div>

          <!-- Subscription Code, Password -->
          <form id="signInForm">
              <div class="mb-3">
              <label for="subscriptionCode-signIn" class="form-label">Channel Subscription Code</label>
              <input type="text" class="form-control" id="subscriptionCode-signIn" placeholder="eg. 000000" required>
              <small class="form-text text-muted">üìçNOTE: If you lost your subscription code, please contact our staff at Telegram <a href="https://t.me/intruderrDetector_bot">@gnomeIntruderDetector</a>.</small>
              </div>
              <div class="mb-3">
                <label for="password-signIn" class="form-label">Password</label>
                <input type="password" class="form-control" id="password-signIn" placeholder="eg. 123456" required>
                <small class="form-text text-muted">Enter your password.</small>
              </div>
              <button type="button" class="btn btn-dark mt-3" id="signInSubmit">Submit</button>
          </form>
          </div>
      </div>
      </div>
    </div>


    <!-- Left Face Photo Upload Modal -->
    <div class="modal fade" id="leftFaceModal" tabindex="-1" aria-labelledby="leftFaceModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="leftFaceModalLabel">Upload Left-Side Face Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Enter your preferred name.</p>
            <input type="text" id="registeredName" class="form-control mb-3" placeholder="eg. Joe Ee" required>
            <!-- Alert placeholder -->
            <div class="mt-4" id="name-placeholder"></div>
            <p>Please upload a clear photo showing your left side face.</p>
            <input type="file" id="leftFacePhoto" class="form-control" accept="image/*" required>
            <small class="form-text text-muted mb-4">üìçNOTE: For better accuracy, please follow the demo image below and ensure that your image has a clean background.</small>
            <!-- Alert placeholder -->
            <div class="mt-4 mb-4" id="left"></div>
            <div class="d-flex justify-content-center align-items-center">
              <img src="../static/images/left.jpg" class="img-fluid" alt="Left Side">
            </div>
            <button type="button" class="btn btn-dark mt-3" id="uploadLeftPhotoButton">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Face Photo Upload Modal -->
    <div class="modal fade" id="rightFaceModal" tabindex="-1" aria-labelledby="rightFaceModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="rightFaceModalLabel">Upload Right-Side Face Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Please upload a clear photo showing your right side face.</p>
            <input type="file" id="rightFacePhoto" class="form-control" accept="image/*">
            <!-- Alert placeholder -->
            <div class="mt-4 mb-4" id="right"></div>
            <small class="form-text text-muted mb-4">üìçNOTE: For better accuracy, please follow the demo image below and ensure that your image has a clean background.</small>
            <div class="d-flex justify-content-center align-items-center">
              <img src="../static/images/right.jpg" class="img-fluid" alt="Right Side Face">
            </div>
            <button type="button" class="btn btn-dark mt-3" id="uploadRightPhotoButton">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Face Photo Upload Modal -->
    <div class="modal fade" id="middleFaceModal" tabindex="-1" aria-labelledby="middleFaceModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="middleFaceModalLabel">Upload Front Face Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Please upload a clear photo showing your front face.</p>
            <input type="file" id="middleFacePhoto" class="form-control" accept="image/*">
            <!-- Alert placeholder -->
            <div class="mt-4 mb-4" id="middle"></div>
            <small class="form-text text-muted mb-4">üìçNOTE: For better accuracy, please follow the demo image below and ensure that your image has a clean background.</small>
            <div class="d-flex justify-content-center align-items-center">
              <img src="../static/images/front.jpg" class="img-fluid" alt="Front Face">
            </div>
            <div class="mt-4 mb-4 d-flex flex-column align-items-center">
              <h6 class="mb-3">Processing image data may take some time...</h6>
              <div class="spinner-border text-dark" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <button type="button" class="btn btn-dark mt-3" id="uploadMiddlePhotoButton">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====================== Hero ====================== -->
    <div id="stay-secure" class="stay-secure row align-items-center d-flex justify-content-center ">
      <div class="col-md-5 mb-4 align-items-center d-flex justify-content-center">
          <img src="../static/images/gnome_logo2.png" class="img-fluid" alt="Stay Secure">
      </div>
      <div class="col-md-5 mt-4 mb-4">
          <h2>Stay Alert, Stay Informed</h2>
          <p>Gnome, the Intruder Detector, is your vigilant companion, keeping an eye on things when you can't.</p>
          <p>Whether you're looking to watch over your personal space or just want peace of mind, this system has you covered.</p>
          <div class="d-flex align-items-center justify-content-start mt-4">
            <a style="margin-right: 15px;" href="https://t.me/intruderrDetector_bot">
              <i class="fab fa-telegram telegram-link"></i>
            </a>
            <p class="mb-0">Visit our <a href="https://t.me/intruderrDetector_bot">Telegram Bot</a> now!</p>
          </div>
      </div>
    </div>

    <!-- ====================== Display ====================== -->
    <section class="display-section text-center" id="display">
      <div class="text container">
        <p class="text-black" id="sameline">Gnome is</p>
        <p id="sameline">
          <span class="word wisteria"> effective.</span>
          <span class="word belize"> efficient.</span>
          <span class="word pomegranate"> reliable.</span>
          <span class="word green"> real-time.</span>
          <span class="word midnight"> secure.</span>
        </p>
      </div>
    </section>

    <!-- ====================== Features ====================== -->
    <div class="container pb-5">
      <div id="features" class="features">
        <h2 class="text-center mb-5 mt-3">Our Features</h2>
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="feature text-center">
              <div
                class="icon d-flex align-items-center justify-content-center mb-3 mt-3"
              >
                <img
                  src="{{ url_for('static', filename='images/icons/real-time.png') }}"
                  alt="Real-Time"
                />
              </div>
              <h3 class="mb-3">Real-Time Intrusion Detection</h3>
              <p>
                The Intruder Detector Bot transforms your mobile phone into a
                vigilant security guard. Utilizing the phone's sensors, it can
                detect any unauthorized presence in its vicinity. The moment an
                intruder is detected, the bot instantly sends an alert via
                Telegram, ensuring you're always aware of what's happening
                around your device.
              </p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="feature text-center">
              <div
                class="icon d-flex align-items-center justify-content-center mb-3 mt-3"
              >
                <img
                  src="{{ url_for('static', filename='images/icons/alert.png') }}"
                  alt="Alerts"
                />
              </div>
              <h3 class="mb-3">Immediate Alerts & Deterrents</h3>
              <p>
                Upon detecting an intruder, the bot doesn‚Äôt just notify you‚Äîit
                takes action. Your mobile phone will emit a loud alarm to scare
                off intruders, and it can also activate a sound repellent to
                further deter them. These features add an extra layer of
                security, providing peace of mind whether you're nearby or away.
              </p>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="feature text-center">
              <div
                class="icon d-flex align-items-center justify-content-center mb-3 mt-3"
              >
                <img
                  src="{{ url_for('static', filename='images/icons/message.png') }}"
                  alt="Notifications"
                />
              </div>
              <h3 class="mb-3">Interactive Notifications</h3>
              <p>
                The alerts you receive aren't just informative‚Äîthey're
                interactive. With a single tap on the notification, you can
                prompt the bot to provide a direct link to a web app, where you
                can view a live video stream from the mobile phone‚Äôs camera.
                This allows you to monitor the situation in real time, no matter
                where you are.
              </p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="feature text-center">
              <div
                class="icon d-flex align-items-center justify-content-center mb-3 mt-3"
              >
                <img
                  src="{{ url_for('static', filename='images/icons/video.png') }}"
                  alt="Videos"
                />
              </div>
              <h3 class="mb-3">Access to Video Evidence</h3>
              <p>
                Missed the live event? No problem. The bot also offers you the
                option to view a short video recording of the intrusion event.
                This feature ensures you have visual evidence of any
                unauthorized activity, which can be crucial for reporting and
                addressing the issue.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====================== Footer ====================== -->
    <footer class="footer small text-center text-white-50 mt-5">
      <div class="container-fluid waves">
        <div class="wave" id="wave1"></div>
        <div class="wave" id="wave2"></div>
        <div class="wave" id="wave3"></div>
        <div class="wave" id="wave4"></div>
      </div>
      <div class="social d-flex justify-content-center align-items-center">
        <a
          class="mx-2"
          href="https://instagram.com/_furrtastic_?utm_source=qr&igshid=NGExMmI2YTkyZg%3D%3D"
          ><i class="fab fa-instagram"></i
        ></a>
        <a
          class="mx-2"
          href="https://www.facebook.com/furtastic.2023?mibextid=ZbWKwL"
          ><i class="fab fa-facebook-f"></i
        ></a>
        <a class="mx-2" href="https://pin.it/7Gfff5a"
          ><i class="fab fa-pinterest"></i
        ></a>
        <a class="mx-2" href="https://github.com/wthislifehuh/Furtastic"
          ><i class="fab fa-github"></i
        ></a>
        <a class="mx-2" href="https://t.me/intruderrDetector_bot"
          ><i class="fab fa-telegram"></i
        ></a>
      </div>
      <div class="container px-4 px-lg-5">
        <p>&copy; Gnome - Intruder Detector 2024 | All Rights Reserved</p>
      </div>
    </footer>

    <script>
      let globalSubscriptionCode = null;
      let registeredName = '';

      // Store subscription code in session via Flask backend
      function storeSubscriptionCodeInSession(subscriptionCode) {
        fetch('/store_subscription_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subscriptionCode: subscriptionCode,
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            console.error("Failed to store subscription code in session.");
          }
        })
        .catch(error => {
          console.error("Error:", error);
        });
      }

      // Sign Up Logic
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('nextStepButton').addEventListener('click', function() {
          const subscriptionCode = document.getElementById('subscriptionCode-signUp').value;
          const password = document.getElementById('password-signUp').value;
          const telegramChatID = document.getElementById('telegramChatID').value;
          const phoneNum = document.getElementById('phoneNum').value;

          // Validate Telegram Chat ID
          const chatIDRegex = /^\d{10}$/;
          if (!chatIDRegex.test(telegramChatID)) {
            showAlertInModal('Telegram Chat ID must be exactly 10 digits.', 'danger', 'modal-alert-placeholder-signUp');
            return;
          }

          const phoneNumFormat = /^\+\d+$/;
          if (!phoneNumFormat.test(phoneNum)) {
            showAlertInModal('Invalid phone number format. It must start with a "+" and contain only digits.', 'danger', 'modal-alert-placeholder-signUp');
            return;
          }


          // AJAX Request to validate subscription code, password, and chat ID
          fetch('/validate_signUp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              subscriptionCode: subscriptionCode,
              password: password,
              telegramChatID: telegramChatID,
              phoneNum: phoneNum,
            }),
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              globalSubscriptionCode = subscriptionCode;
              storeSubscriptionCodeInSession(subscriptionCode);  // Store in session
              showLeftFaceUploadModal();  // Proceed to face photo upload
            } else {
              showAlertInModal(data.message, 'danger', 'modal-alert-placeholder-signUp');
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            showAlertInModal('An error occurred. Please try again later.', 'danger', 'modal-alert-placeholder-signUp');
          });
        });
      });

      // Sign In Logic
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('signInSubmit').addEventListener('click', function() {
          const subscriptionCode = document.getElementById('subscriptionCode-signIn').value;
          const password = document.getElementById('password-signIn').value;

          // AJAX Request to validate subscription code and password
          fetch('/validate_signIn', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              subscriptionCode: subscriptionCode,
              password: password,
            }),
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              globalSubscriptionCode = subscriptionCode;
              storeSubscriptionCodeInSession(subscriptionCode);  // Store in session
              window.location.href = '/home';  // Redirect to home
            } else {
              showAlertInModal(data.message, 'danger', 'modal-alert-placeholder-signIn');
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            showAlertInModal('An error occurred. Please try again later.', 'danger', 'modal-alert-placeholder-signIn');
          });
        });
      });

      // Function to display a Bootstrap alert inside the modal
      function showAlertInModal(message, type, placeholder) {
        const alertPlaceholder = document.getElementById(placeholder);
        const alertHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        alertPlaceholder.innerHTML = alertHTML;
      }

      // ================================ Upload Photo and Processing =================================
      function showLeftFaceUploadModal() {
        // Hide the sign-in modal
        const signInModalElement = document.getElementById('signUpModal');
        const signInModalInstance = bootstrap.Modal.getInstance(signInModalElement);
        if (signInModalInstance) {
          signInModalInstance.hide();
        }

        // Show the left-side face photo upload modal
        const leftFaceModal = new bootstrap.Modal(document.getElementById('leftFaceModal'));
        leftFaceModal.show();
      }

      function showRightFaceUploadModal() {
        // Hide the left-side face modal
        const leftFaceModalElement = document.getElementById('leftFaceModal');
        const leftFaceModalInstance = bootstrap.Modal.getInstance(leftFaceModalElement);
        if (leftFaceModalInstance) {
          leftFaceModalInstance.hide(); // Hide the left-side face modal
        }

        // Show the right-side face photo upload modal
        const rightFaceModal = new bootstrap.Modal(document.getElementById('rightFaceModal'));
        rightFaceModal.show();
      }

      function showMiddleFaceUploadModal() {
        // Hide the right-side face modal
        const rightFaceModalElement = document.getElementById('rightFaceModal');
        const rightFaceModalInstance = bootstrap.Modal.getInstance(rightFaceModalElement);
        if (rightFaceModalInstance) {
          rightFaceModalInstance.hide(); // Hide the right-side face modal
        }

        // Show the middle face photo upload modal
        const middleFaceModal = new bootstrap.Modal(document.getElementById('middleFaceModal'));
        middleFaceModal.show();
      }

      document.getElementById('uploadLeftPhotoButton').addEventListener('click', function() {
          const fileInput = document.getElementById('leftFacePhoto').files[0];
          registeredName = document.getElementById('registeredName').value.trim();  // Capture registered name
          if (registeredName.length > 0) {
            handleUploadPhoto(fileInput, 'left');
          }
          else{
            showAlertInModal("Please enter a valid name", "danger", "name-placeholder");
          }
      });

      document.getElementById('uploadRightPhotoButton').addEventListener('click', function() {
          const fileInput = document.getElementById('rightFacePhoto').files[0];
          handleUploadPhoto(fileInput, 'right');
      });

      document.getElementById('uploadMiddlePhotoButton').addEventListener('click', function() {
          const fileInput = document.getElementById('middleFacePhoto').files[0];
          handleUploadPhoto(fileInput, 'middle');
      });


      let uploadedImagePaths = [];  // To store the file paths of the uploaded images

      function handleUploadPhoto(file, faceType) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('subscriptionCode', globalSubscriptionCode);
          formData.append('side', faceType);
          if (registeredName) {
              formData.append('registeredName', registeredName);  
          }

          fetch('/upload_photo', {
            method: 'POST',
            body: formData,
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              uploadedImagePaths.push(data.file_path);  
              
              if (faceType === 'left') {
                showRightFaceUploadModal();
              } else if (faceType === 'right') {
                showMiddleFaceUploadModal();
              } else if (faceType === 'middle') {
                if (uploadedImagePaths.length === 3) {
                  window.location.href = '/home';
                  triggerEmbeddingProcessing(uploadedImagePaths);
                }
              }
            } else {
              showAlertInModal(data.message, 'danger', faceType);
            }
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }

      function triggerEmbeddingProcessing(imagePaths) {
        const formData = new FormData();
        formData.append('imagePaths', JSON.stringify(imagePaths));  // Ensure imagePaths is JSON
        formData.append('subscriptionCode', globalSubscriptionCode);  // Pass subscription code

          fetch('/process_embeddings', {
            method: 'POST',
            body: formData,
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showSuccessModal("Successfully uploaded and processed images.", "success");
            } else {
              // showAlertInModal(data.message, 'danger', 'embedding-error');
              console.error('Data message:', data.message);
            }
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      }
    </script>
    
        

    <!-- Bootstrap core JS-->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>

    <!-- Core theme JS-->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <!-- <script src="./index.js"></script> -->
  </body>
</html>
